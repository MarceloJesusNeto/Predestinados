<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>CineMatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="/img/cinematchlogo1-removebg-preview (1).png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/home.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
</head>
<body>
<header th:if="${session != null and session.usuarioLogado != null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <nav class="nav-links">
        <a href="/">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="/pesquisa">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Pesquisar</span>
        </a>
        <a href="/chat">
            <i class="fa-solid fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="/curtidos">
            <i class="fa-solid fa-heart"></i>
            <span>Favoritos</span>
        </a>
        <a href="/perfil">
            <i class="fa-solid fa-user"></i>
            <span>Perfil</span>
        </a>
    </nav>
</header>

<header  th:if="${session == null or session.usuarioLogado == null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <div class="header-actions">
        <a href="/login" class="btn-login">Entrar</a>
        <a href="/registrar" class="btn-cadastrar">Cadastrar</a>
    </div>
</header>

<main>

    <section class="hero" id="inicio"  th:if="${session == null or session.usuarioLogado == null}">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <div class="bemvindo">ðŸŽ¥ Bem-vindo ao</div>

            <div class="titulo-hero">CineMatch</div>
            <div class="subtitulo-hero">
                Onde o amor pelo cinema cria conexÃµes reais.<br>
                Descubra quem vibra, se emociona e sonha com as mesmas histÃ³rias que vocÃª.
            </div>
            <a href="#catalogo" class="btn-hero" id="btnExplorar">
                <i class="fa-solid fa-film" href="/registrar"></i> Explorar Agora
            </a>
        </div>

        <div class="scroll-indicator">
            <div class="bar"></div>
        </div>

        <div class="wave">
            <svg viewBox="0 0 1440 120" preserveAspectRatio="none">
                <path d="M0,32 C220,120 440,0 720,48 C1000,96 1220,16 1440,64 L1440 120 L0 120 Z" fill="#0b0014"></path>
            </svg>
        </div>
    </section>

    <section class="titulo-sessao">
        <div class="titulo-container">
            <h2>ðŸŽ¬ Alguns tÃ­tulos pra vocÃª:</h2>
        </div>
    </section>

    <!-- CATÃLOGO original -->
    <section th:if="${session != null and session.usuarioLogado != null}" class="catalogo" id="catalogo">
        <div th:each="filme : ${filmes}" class="card">
            <img th:src="${#strings.replace(filme.imagem, '._V1_', '._V1_UX200_')}"
                 alt="Poster do filme" loading="lazy">
            <h3 th:text="${filme.titulo}">TÃ­tulo</h3>
            <p th:text="${filme.genero}">GÃªnero</p>
            <div class="botoes">
                <button th:data-id="${filme.imdbId}" th:data-titulo="${filme.titulo}"
                        th:data-imagem="${filme.imagem}" th:data-genero="${filme.genero}"
                        class="btn-favoritar" onclick="favoritarFilme(this)">
                    <i class="fa-solid fa-heart"></i> Favoritar
                </button>
                <button th:data-id="${filme.imdbId}"
                        th:data-titulo="${filme.titulo}"
                        th:data-imagem="${filme.imagem}"
                        th:data-genero="${filme.genero}"
                        class="btn-salvar"
                        onclick="salvarFilme(this)">
                    <i class="fa-solid fa-bookmark"></i> Salvar
                </button>
            </div>
        </div>

    </section>

    <div th:if="${session != null and session.usuarioLogado != null}" class="carregar-mais-container" style="text-align:center; margin:40px 0;">
        <button id="btnCarregarMais" class="btn-carregar-mais" th:if="${temMais}">Carregar mais</button>
        <p id="semMaisFilmes" style="display:none; color:#666;">NÃ£o hÃ¡ mais filmes para carregar</p>
    </div>

    <section  th:if="${session == null or session.usuarioLogado == null}" class="catalogo">
        <div th:each="filme : ${filmes}" class="card">
            <img th:src="${filme.imagem}" alt="Poster do filme" loading="lazy">
            <h3 th:text="${filme.titulo}">TÃ­tulo</h3>
            <p th:text="${filme.genero}">GÃªnero</p>
        </div>
    </section>
</main>

<div id="modalFilme" class="modal">
    <div class="modal-content">
        <span class="fechar">&times;</span>
        <div class="modal-poster">
            <img id="posterFilme" src="" alt="Poster do filme">
        </div>
        <div class="modal-info">
            <h2 id="tituloFilme"></h2>
            <p id="descricaoFilme"></p>
            <div class="nota-filme">
                <i class="fa-solid fa-star"></i> <span id="notaFilme">â€”</span>
            </div>
            <div class="botoes-modal">
                <button id="btnFavoritarModal" class="btn-favoritar">
                    <i class="fa-solid fa-heart"></i> Favoritar
                </button>
                <button id="btnSalvarModal" class="btn-salvar">
                    <i class="fa-solid fa-bookmark"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-container">
        <div class="footer-col">
            <img th:src="@{/img/cinematchlogo1-removebg-preview.png}" alt="Cinemach" class="footer-logo">
            <p>SoluÃ§Ãµes de recomendaÃ§Ã£o e descoberta de filmes personalizadas.</p>
        </div>

        <div class="footer-col">
            <h4>Links RÃ¡pidos</h4>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/registrar">Pesquisar</a></li>
                <li><a href="/registrar">Chat</a></li>
                <li><a href="/registrar">Favoritos</a></li>
                <li><a href="/registrar">Perfil</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4>Contato</h4>
            <p><i class="fa-solid fa-location-dot"></i> Rua Exemplo, 123 - SÃ£o Paulo, SP</p>
            <p><i class="fa-solid fa-phone"></i> (11) 1234-5678</p>
            <p><i class="fa-solid fa-envelope"></i> contato@cinematch.com.br</p>
        </div>
    </div>

    <div class="footer-bottom">
        <p>Â© 2025 Cinematch. Todos os direitos reservados.</p>
    </div>
</footer>

<div id="loading" class="loading">
    <div class="spinner"></div>
</div>

<script src="https://kit.fontawesome.com/a2e0e6c6c1.js" crossorigin="anonymous"></script>

<script src="/js/filmes.js"></script>

<script>
    // VariÃ¡veis globais
    let carregando = false;
    let favoritosIds = [];
    let salvosIds = [];

    document.addEventListener("DOMContentLoaded", function() {
        const btnCarregarMais = document.getElementById("btnCarregarMais");

        if (btnCarregarMais) {
            btnCarregarMais.addEventListener("click", carregarMaisFilmes);
        }

        inicializarModal();
        inicializarFavoritosESalvos();
        inicializarEventListenersCards();
    });

    // ==========================
    // FUNÃ‡ÃƒO PARA CARREGAR MAIS FILMES
    // ==========================
    async function carregarMaisFilmes() {
        if (carregando) return;

        const btn = document.getElementById("btnCarregarMais");
        const semMaisFilmes = document.getElementById("semMaisFilmes");

        carregando = true;
        btn.disabled = true;
        btn.textContent = "Carregando...";

        try {
            const response = await fetch('/filmes/mais');
            const novosFilmes = await response.json();

            if (novosFilmes.length === 0) {
                btn.style.display = "none";
                if (semMaisFilmes) {
                    semMaisFilmes.style.display = "block";
                }
                return;
            }

            const catalogo = document.querySelector(".catalogo");

            novosFilmes.forEach(filme => {
                const card = criarCardFilme(filme);
                catalogo.appendChild(card);
            });

            // Re-inicializar os event listeners para os novos cards
            inicializarEventListenersCards();

            btn.textContent = "Carregar mais";
            btn.disabled = false;

        } catch (error) {
            console.error("Erro ao carregar mais filmes:", error);
            btn.textContent = "Erro ao carregar";
            setTimeout(() => {
                btn.textContent = "Carregar mais";
                btn.disabled = false;
            }, 2000);
        } finally {
            carregando = false;
        }
    }

    // ==========================
    // FUNÃ‡ÃƒO PARA CRIAR CARD DE FILME
    // ==========================
    function criarCardFilme(filme) {
        const card = document.createElement("div");
        card.classList.add("card");

        const isFavoritado = favoritosIds.includes(filme.imdbId);
        const isSalvo = salvosIds.includes(filme.imdbId);

        card.innerHTML = `
            <img src="${filme.imagem}" alt="Poster do filme ${filme.titulo}" loading="lazy">
            <h3>${filme.titulo}</h3>
            <p>${filme.genero}</p>
            <div class="botoes">
                <button class="btn-favoritar ${isFavoritado ? 'favoritado' : ''}"
                        data-id="${filme.imdbId}"
                        data-titulo="${filme.titulo}"
                        data-imagem="${filme.imagem}"
                        data-genero="${filme.genero}">
                    <i class="fa-solid ${isFavoritado ? 'fa-heart-circle-check' : 'fa-heart'}"></i>
                    ${isFavoritado ? 'Favoritado' : 'Favoritar'}
                </button>
                <button class="btn-salvar ${isSalvo ? 'salvo' : ''}"
                        data-id="${filme.imdbId}"
                        data-titulo="${filme.titulo}"
                        data-imagem="${filme.imagem}"
                        data-genero="${filme.genero}">
                    <i class="fa-solid ${isSalvo ? 'fa-bookmark-circle-check' : 'fa-bookmark'}"></i>
                    ${isSalvo ? 'Salvo' : 'Salvar'}
                </button>
            </div>
        `;

        return card;
    }

    // ==========================
    // INICIALIZAR EVENT LISTENERS DOS CARDS
    // ==========================
    function inicializarEventListenersCards() {
        document.querySelectorAll(".card").forEach(card => {
            // Remover event listeners existentes para evitar duplicaÃ§Ã£o
            const novoCard = card.cloneNode(true);
            card.parentNode.replaceChild(novoCard, card);

            const btnFavoritar = novoCard.querySelector(".btn-favoritar");
            const btnSalvar = novoCard.querySelector(".btn-salvar");

            if (btnFavoritar) {
                btnFavoritar.addEventListener("click", function(e) {
                    e.stopPropagation();
                    favoritarFilme(this);
                });
            }

            if (btnSalvar) {
                btnSalvar.addEventListener("click", function(e) {
                    e.stopPropagation();
                    salvarFilme(this);
                });
            }

            // Event listener para abrir modal
            novoCard.addEventListener("click", function(e) {
                if (!e.target.closest(".btn-favoritar") && !e.target.closest(".btn-salvar")) {
                    abrirModalFilme(this);
                }
            });
        });
    }

    // ==========================
    // FUNÃ‡Ã•ES DE FAVORITAR/SALVAR
    // ==========================
    window.favoritarFilme = async function(botao) {
        const imdbId = botao.dataset.id;
        const titulo = botao.dataset.titulo;
        const imagem = botao.dataset.imagem;
        const genero = botao.dataset.genero;

        try {
            const resposta = await fetch("/favoritar", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ imdbId, titulo, imagem, genero })
            });
            const resultado = await resposta.text();

            if (resultado === "ADICIONADO") {
                favoritosIds.push(imdbId);
                atualizarEstadoBotaoFavorito(imdbId, true);
            } else if (resultado === "REMOVIDO") {
                favoritosIds = favoritosIds.filter(id => id !== imdbId);
                atualizarEstadoBotaoFavorito(imdbId, false);
            }
        } catch (erro) {
            console.error("Erro ao favoritar:", erro);
        }
    };

    window.salvarFilme = async function(botao) {
        const imdbId = botao.dataset.id;
        const titulo = botao.dataset.titulo;
        const imagem = botao.dataset.imagem;
        const genero = botao.dataset.genero;

        try {
            const resposta = await fetch("/perfil/salvar", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ imdbId, titulo, imagem, genero })
            });
            const resultado = await resposta.text();

            if (resultado === "ADICIONADO") {
                salvosIds.push(imdbId);
                atualizarEstadoBotaoSalvar(imdbId, true);
            } else if (resultado === "REMOVIDO") {
                salvosIds = salvosIds.filter(id => id !== imdbId);
                atualizarEstadoBotaoSalvar(imdbId, false);
            }
        } catch (erro) {
            console.error("Erro ao salvar:", erro);
        }
    };

    // ==========================
    // ATUALIZAR ESTADO DOS BOTÃ•ES
    // ==========================
    function atualizarEstadoBotaoFavorito(imdbId, ativo) {
        document.querySelectorAll(`.btn-favoritar[data-id="${imdbId}"]`).forEach(btn => {
            if (ativo) {
                btn.classList.add("favoritado");
                btn.innerHTML = '<i class="fa-solid fa-heart-circle-check"></i> Favoritado';
            } else {
                btn.classList.remove("favoritado");
                btn.innerHTML = '<i class="fa-solid fa-heart"></i> Favoritar';
            }
        });
    }

    function atualizarEstadoBotaoSalvar(imdbId, ativo) {
        document.querySelectorAll(`.btn-salvar[data-id="${imdbId}"]`).forEach(btn => {
            if (ativo) {
                btn.classList.add("salvo");
                btn.innerHTML = '<i class="fa-solid fa-bookmark-circle-check"></i> Salvo';
            } else {
                btn.classList.remove("salvo");
                btn.innerHTML = '<i class="fa-solid fa-bookmark"></i> Salvar';
            }
        });
    }

    // ==========================
    // FUNÃ‡ÃƒO PARA ABRIR MODAL
    // ==========================
    async function abrirModalFilme(card) {
        const imdbId = card.querySelector(".btn-favoritar")?.dataset.id;
        if (!imdbId) return;

        try {
            const resposta = await fetch(`/detalhes/${imdbId}`);
            const filme = await resposta.json();

            const modal = document.getElementById("modalFilme");
            const poster = document.getElementById("posterFilme");
            const titulo = document.getElementById("tituloFilme");
            const descricao = document.getElementById("descricaoFilme");
            const nota = document.getElementById("notaFilme");
            const btnFavoritarModal = document.getElementById("btnFavoritarModal");
            const btnSalvarModal = document.getElementById("btnSalvarModal");

            poster.src = filme.imagem || card.querySelector("img").src;
            titulo.textContent = filme.titulo || "TÃ­tulo nÃ£o disponÃ­vel";
            descricao.textContent = filme.descricao || "DescriÃ§Ã£o nÃ£o disponÃ­vel.";
            nota.textContent = filme.nota || "â€”";

            // Atualizar dados dos botÃµes do modal
            [btnFavoritarModal, btnSalvarModal].forEach(btn => {
                btn.dataset.id = imdbId;
                btn.dataset.titulo = filme.titulo;
                btn.dataset.imagem = filme.imagem;
                btn.dataset.genero = filme.genero;
            });

            // Atualizar estado dos botÃµes no modal
            atualizarEstadoBotaoFavorito(imdbId, favoritosIds.includes(imdbId));
            atualizarEstadoBotaoSalvar(imdbId, salvosIds.includes(imdbId));

            // Atualizar listeners dos botÃµes do modal
            atualizarListenersModal();

            modal.style.display = "flex";
            document.body.classList.add("modal-ativo");

        } catch (e) {
            console.error("Erro ao buscar detalhes:", e);
        }
    }

    // ==========================
    // INICIALIZAR MODAL
    // ==========================
    function inicializarModal() {
        const modal = document.getElementById("modalFilme");
        const fechar = modal.querySelector(".fechar");

        // Fechar modal com X
        fechar.onclick = () => {
            modal.style.display = "none";
            document.body.classList.remove("modal-ativo");
        };

        // Fechar modal clicando fora
        modal.addEventListener("click", e => {
            if (e.target === modal) {
                modal.style.display = "none";
                document.body.classList.remove("modal-ativo");
            }
        });

        // Fechar modal com ESC
        document.addEventListener("keydown", e => {
            if (e.key === "Escape" && modal.style.display === "flex") {
                modal.style.display = "none";
                document.body.classList.remove("modal-ativo");
            }
        });
    }

    // ==========================
    // ATUALIZAR LISTENERS DO MODAL
    // ==========================
    function atualizarListenersModal() {
        const btnFavoritarModal = document.getElementById("btnFavoritarModal");
        const btnSalvarModal = document.getElementById("btnSalvarModal");

        // Remover listeners antigos
        const novoBtnFavoritar = btnFavoritarModal.cloneNode(true);
        const novoBtnSalvar = btnSalvarModal.cloneNode(true);

        btnFavoritarModal.replaceWith(novoBtnFavoritar);
        btnSalvarModal.replaceWith(novoBtnSalvar);

        // Adicionar novos listeners
        novoBtnFavoritar.addEventListener("click", (e) => {
            e.stopPropagation();
            favoritarFilme(novoBtnFavoritar);
        });

        novoBtnSalvar.addEventListener("click", (e) => {
            e.stopPropagation();
            salvarFilme(novoBtnSalvar);
        });
    }

    // ==========================
    // INICIALIZAR FAVORITOS E SALVOS
    // ==========================
    async function inicializarFavoritosESalvos() {
        try {
            const [respFav, respSalvo] = await Promise.all([
                fetch("/favoritos/ids"),
                fetch("/perfil/salvos/ids")
            ]);

            if (respFav.ok) favoritosIds = await respFav.json();
            if (respSalvo.ok) salvosIds = await respSalvo.json();

            // Atualizar estado inicial dos botÃµes
            favoritosIds.forEach(id => atualizarEstadoBotaoFavorito(id, true));
            salvosIds.forEach(id => atualizarEstadoBotaoSalvar(id, true));

        } catch (e) {
            console.warn("Erro ao carregar estados iniciais:", e);
        }
    }

    // ==========================
    // FUNÃ‡Ã•ES AUXILIARES
    // ==========================

    // FunÃ§Ã£o para mostrar loading
    function mostrarLoading() {
        const loading = document.getElementById("loading");
        if (loading) loading.style.display = "flex";
    }

    // FunÃ§Ã£o para esconder loading
    function esconderLoading() {
        const loading = document.getElementById("loading");
        if (loading) loading.style.display = "none";
    }

    // FunÃ§Ã£o para mostrar mensagem temporÃ¡ria
    function mostrarMensagem(mensagem, tipo = "info") {
        const mensagemDiv = document.createElement("div");
        mensagemDiv.className = `mensagem-flutuante ${tipo}`;
        mensagemDiv.textContent = mensagem;
        mensagemDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        `;

        if (tipo === "sucesso") {
            mensagemDiv.style.background = "linear-gradient(135deg, #00cc66, #00ff88)";
        } else if (tipo === "erro") {
            mensagemDiv.style.background = "linear-gradient(135deg, #ff4444, #ff6666)";
        } else {
            mensagemDiv.style.background = "linear-gradient(135deg, #e60073, #ff1493)";
        }

        document.body.appendChild(mensagemDiv);

        setTimeout(() => {
            mensagemDiv.style.animation = "slideOut 0.3s ease";
            setTimeout(() => {
                if (mensagemDiv.parentNode) {
                    mensagemDiv.parentNode.removeChild(mensagemDiv);
                }
            }, 300);
        }, 3000);
    }

    // Adicionar estilos CSS para animaÃ§Ãµes
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        .mensagem-flutuante {
            font-family: 'Nunito', sans-serif;
        }

        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(11, 0, 20, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(230, 0, 115, 0.3);
            border-top: 5px solid #e60073;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);

    // ==========================
    // INICIALIZAÃ‡ÃƒO ADICIONAL
    // ==========================

    // Prevenir envio duplo de formulÃ¡rios
    document.addEventListener('DOMContentLoaded', function() {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                const submitBtn = this.querySelector('button[type="submit"]');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    setTimeout(() => {
                        submitBtn.disabled = false;
                    }, 3000);
                }
            });
        });
    });

    // Smooth scroll para links Ã¢ncora
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
</script>
</body>
</html>
