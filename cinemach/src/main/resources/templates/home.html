<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>CineMatch</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="shortcut icon" href="/img/cinematchlogo1-removebg-preview (1).png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="/css/home.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
</head>
<body>
<header th:if="${session != null and session.usuarioLogado != null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <nav class="nav-links">
        <a href="/">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="/pesquisa">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Pesquisar</span>
        </a>
        <a href="/chat">
            <i class="fa-solid fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="/curtidos">
            <i class="fa-solid fa-heart"></i>
            <span>Favoritos</span>
        </a>
        <a href="/perfil">
            <i class="fa-solid fa-user"></i>
            <span>Perfil</span>
        </a>
    </nav>
</header>

<header  th:if="${session == null or session.usuarioLogado == null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <div class="header-actions">
        <a href="/login" class="btn-login">Entrar</a>
        <a href="/registrar" class="btn-cadastrar">Cadastrar</a>
    </div>
</header>

<main>

    <section class="hero" id="inicio"  th:if="${session == null or session.usuarioLogado == null}">
        <div class="hero-bg"></div>
        <div class="hero-overlay"></div>
        <div class="hero-content">
            <div class="bemvindo">ðŸŽ¥ Bem-vindo ao</div>

            <div class="titulo-hero">CineMatch</div>
            <div class="subtitulo-hero">
                Onde o amor pelo cinema cria conexÃµes reais.<br>
                Descubra quem vibra, se emociona e sonha com as mesmas histÃ³rias que vocÃª.
            </div>
            <a href="#catalogo" class="btn-hero" id="btnExplorar">
                <i class="fa-solid fa-film" href="/registrar"></i> Explorar Agora
            </a>
        </div>

        <div class="scroll-indicator">
            <div class="bar"></div>
        </div>

        <div class="wave">
            <svg viewBox="0 0 1440 120" preserveAspectRatio="none">
                <path d="M0,32 C220,120 440,0 720,48 C1000,96 1220,16 1440,64 L1440 120 L0 120 Z" fill="#0b0014"></path>
            </svg>
        </div>
    </section>

    <section class="titulo-sessao">
        <div class="titulo-container">
            <h2>ðŸŽ¬ Alguns tÃ­tulos pra vocÃª:</h2>
        </div>
    </section>

    <!-- CATÃLOGO original -->
    <section th:if="${session != null and session.usuarioLogado != null}" class="catalogo" id="catalogo">
        <div th:each="filme : ${filmes}" class="card">
            <img th:src="${#strings.replace(filme.imagem, '._V1_', '._V1_UX200_')}"
                 alt="Poster do filme" loading="lazy">
            <h3 th:text="${filme.titulo}">TÃ­tulo</h3>
            <p th:text="${filme.genero}">GÃªnero</p>
            <div class="botoes">
                <button th:data-id="${filme.imdbId}" th:data-titulo="${filme.titulo}"
                        th:data-imagem="${filme.imagem}" th:data-genero="${filme.genero}"
                        class="btn-favoritar" onclick="favoritarFilme(this)">
                    <i class="fa-solid fa-heart"></i> Favoritar
                </button>
                <button th:data-id="${filme.imdbId}"
                        th:data-titulo="${filme.titulo}"
                        th:data-imagem="${filme.imagem}"
                        th:data-genero="${filme.genero}"
                        class="btn-salvar"
                        onclick="salvarFilme(this)">
                    <i class="fa-solid fa-bookmark"></i> Salvar
                </button>
            </div>
        </div>

    </section>

    <div th:if="${session != null and session.usuarioLogado != null}" class="carregar-mais-container" style="text-align:center; margin:40px 0;">
        <button id="btnCarregarMais" class="btn-carregar-mais">Carregar mais</button>
    </div>

    <section  th:if="${session == null or session.usuarioLogado == null}" class="catalogo">
        <div th:each="filme : ${filmes}" class="card">
            <img th:src="${filme.imagem}" alt="Poster do filme" loading="lazy">
            <h3 th:text="${filme.titulo}">TÃ­tulo</h3>
            <p th:text="${filme.genero}">GÃªnero</p>
        </div>
    </section>
</main>

<div id="modalFilme" class="modal">
    <div class="modal-content">
        <span class="fechar">&times;</span>
        <div class="modal-poster">
            <img id="posterFilme" src="" alt="Poster do filme">
        </div>
        <div class="modal-info">
            <h2 id="tituloFilme"></h2>
            <p id="descricaoFilme"></p>
            <div class="nota-filme">
                <i class="fa-solid fa-star"></i> <span id="notaFilme">â€”</span>
            </div>
            <div class="botoes-modal">
                <button id="btnFavoritarModal" class="btn-favoritar">
                    <i class="fa-solid fa-heart"></i> Favoritar
                </button>
                <button id="btnSalvarModal" class="btn-salvar">
                    <i class="fa-solid fa-bookmark"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<footer class="footer">
    <div class="footer-container">
        <div class="footer-col">
            <img th:src="@{/img/cinematchlogo1-removebg-preview.png}" alt="Cinemach" class="footer-logo">
            <p>SoluÃ§Ãµes de recomendaÃ§Ã£o e descoberta de filmes personalizadas.</p>
        </div>

        <div class="footer-col">
            <h4>Links RÃ¡pidos</h4>
            <ul>
                <li><a href="/">Home</a></li>
                <li><a href="/registrar">Pesquisar</a></li>
                <li><a href="/registrar">Chat</a></li>
                <li><a href="/registrar">Favoritos</a></li>
                <li><a href="/registrar">Perfil</a></li>
            </ul>
        </div>

        <div class="footer-col">
            <h4>Contato</h4>
            <p><i class="fa-solid fa-location-dot"></i> Rua Exemplo, 123 - SÃ£o Paulo, SP</p>
            <p><i class="fa-solid fa-phone"></i> (11) 1234-5678</p>
            <p><i class="fa-solid fa-envelope"></i> contato@cinematch.com.br</p>
        </div>
    </div>

    <div class="footer-bottom">
        <p>Â© 2025 Cinematch. Todos os direitos reservados.</p>
    </div>
</footer>

<div id="loading" class="loading">
    <div class="spinner"></div>
</div>

<script src="https://kit.fontawesome.com/a2e0e6c6c1.js" crossorigin="anonymous"></script>

<script src="/js/filmes.js"></script>

<script>
    let offset = 27;

document.getElementById("btnCarregarMais").addEventListener("click", async () => {
    const btn = document.getElementById("btnCarregarMais");
    btn.disabled = true;
    btn.textContent = "Carregando...";

    try {
        const response = await fetch(`/filmes/mais?offset=${offset}`);
        const novosFilmes = await response.json();

        if (novosFilmes.length === 0) {
            btn.textContent = "NÃ£o hÃ¡ mais filmes";
            btn.disabled = true;
            return;
        }

        const catalogo = document.querySelector(".catalogo");

        novosFilmes.forEach(filme => {
            const card = document.createElement("div");
            card.classList.add("card");
            card.innerHTML = `
                <img src="${filme.imagem}" alt="Poster do filme" loading="lazy">
                <h3>${filme.titulo}</h3>
                <p>${filme.genero}</p>
                <div class="botoes">
                    <button class="btn-favoritar" data-id="${filme.imdbId}" data-titulo="${filme.titulo}" data-imagem="${filme.imagem}" data-genero="${filme.genero}" onclick="favoritarFilme(this)">
                        <i class="fa-solid fa-heart"></i> Favoritar
                    </button>
                    <button class="btn-salvar" data-id="${filme.imdbId}" data-titulo="${filme.titulo}" data-imagem="${filme.imagem}" data-genero="${filme.genero}" onclick="salvarFilme(this)">
                        <i class="fa-solid fa-bookmark"></i> Salvar
                    </button>
                </div>
            `;
            catalogo.appendChild(card);
        });

        offset += novosFilmes.length;
        btn.textContent = "Carregar mais";
        btn.disabled = false;

    } catch (error) {
        console.error("Erro ao carregar mais filmes:", error);
        btn.textContent = "Erro ao carregar";
    }
});
document.addEventListener("DOMContentLoaded", async function () {

  const modal = document.getElementById("modalFilme");
  const poster = document.getElementById("posterFilme");
  const titulo = document.getElementById("tituloFilme");
  const descricao = document.getElementById("descricaoFilme");
  const nota = document.getElementById("notaFilme");
  const fechar = modal.querySelector(".fechar");
  const btnFavoritarModal = document.getElementById("btnFavoritarModal");
  const btnSalvarModal = document.getElementById("btnSalvarModal");

  let favoritosIds = [];
  let salvosIds = [];

  // ==========================
  // FUNÃ‡Ã•ES DE FAVORITAR/SALVAR
  // ==========================
  window.favoritarFilme = async function (botao) {
    const imdbId = botao.dataset.id;
    const titulo = botao.dataset.titulo;
    const imagem = botao.dataset.imagem;
    const genero = botao.dataset.genero;

    try {
      const resposta = await fetch("/favoritar", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ imdbId, titulo, imagem, genero })
      });
      const resultado = await resposta.text();

      if (resultado === "ADICIONADO") {
        favoritosIds.push(imdbId);
        atualizarEstadoBotaoFavorito(imdbId, true);
      } else if (resultado === "REMOVIDO") {
        favoritosIds = favoritosIds.filter(id => id !== imdbId);
        atualizarEstadoBotaoFavorito(imdbId, false);
      }
    } catch (erro) {
      console.error("Erro ao favoritar:", erro);
    }
  };



  // ==========================
  // VISUAL DOS BOTÃ•ES
  // ==========================
  function atualizarEstadoBotaoFavorito(imdbId, ativo) {
    document.querySelectorAll(`.btn-favoritar[data-id="${imdbId}"]`).forEach(btn => {
      if (ativo) {
        btn.classList.add("favoritado");
        btn.innerHTML = '<i class="fa-solid fa-heart-circle-check"></i> Favoritado';
      } else {
        btn.classList.remove("favoritado");
        btn.innerHTML = '<i class="fa-solid fa-heart"></i> Favoritar';
      }
    });
  }

  function atualizarEstadoBotaoSalvar(imdbId, ativo) {
    document.querySelectorAll(`.btn-salvar[data-id="${imdbId}"]`).forEach(btn => {
      if (ativo) {
        btn.classList.add("salvo");
        btn.innerHTML = '<i class="fa-solid fa-bookmark-circle-check"></i> Salvo';
      } else {
        btn.classList.remove("salvo");
        btn.innerHTML = '<i class="fa-solid fa-bookmark"></i> Salvar';
      }
    });
  }

  // ==========================
  // CARREGAR ESTADO
  // ==========================
  try {
    const [respFav, respSalvo] = await Promise.all([
      fetch("/favoritos/ids"),
      fetch("/perfil/salvos/ids")
    ]);

    if (respFav.ok) favoritosIds = await respFav.json();
    if (respSalvo.ok) salvosIds = await respSalvo.json();

    favoritosIds.forEach(id => atualizarEstadoBotaoFavorito(id, true));
    salvosIds.forEach(id => atualizarEstadoBotaoSalvar(id, true));
  } catch (e) {
    console.warn("Erro ao carregar estados:", e);
  }

  // ==========================
  // ABRIR MODAL (UMA ÃšNICA VEZ)
  // ==========================
  document.querySelectorAll(".card").forEach(card => {
    card.addEventListener("click", async (e) => {
      if (e.target.closest(".btn-favoritar") || e.target.closest(".btn-salvar")) return;

      const imdbId = card.querySelector(".btn-favoritar")?.dataset.id;
      if (!imdbId) return;

      try {
        const resposta = await fetch(`/detalhes/${imdbId}`);
        const filme = await resposta.json();

        poster.src = filme.imagem || card.querySelector("img").src;
        titulo.textContent = filme.titulo || "TÃ­tulo nÃ£o disponÃ­vel";
        descricao.textContent = filme.descricao || "DescriÃ§Ã£o nÃ£o disponÃ­vel.";
        nota.textContent = filme.nota || "â€”";

        [btnFavoritarModal, btnSalvarModal].forEach(btn => {
          btn.dataset.id = imdbId;
          btn.dataset.titulo = filme.titulo;
          btn.dataset.imagem = filme.imagem;
          btn.dataset.genero = filme.genero;
        });

        atualizarEstadoBotaoFavorito(imdbId, favoritosIds.includes(imdbId));
        atualizarEstadoBotaoSalvar(imdbId, salvosIds.includes(imdbId));

        modal.style.display = "flex";
        document.body.classList.add("modal-ativo");
      } catch (e) {
        console.error("Erro ao buscar detalhes:", e);
      }
    });
  });

  // ==========================
  // BOTÃ•ES DO MODAL
  // ==========================
function atualizarListenersModal() {
  // Clona os botÃµes para remover listeners antigos
  const novoBtnFavoritar = btnFavoritarModal.cloneNode(true);
  const novoBtnSalvar = btnSalvarModal.cloneNode(true);

  // Substitui no DOM
  btnFavoritarModal.replaceWith(novoBtnFavoritar);
  btnSalvarModal.replaceWith(novoBtnSalvar);

  // Atualiza as referÃªncias globais
  window.btnFavoritarModal = novoBtnFavoritar;
  window.btnSalvarModal = novoBtnSalvar;

  // Adiciona listeners novos e limpos
  novoBtnFavoritar.addEventListener("click", (e) => {
    e.stopPropagation();
    favoritarFilme(novoBtnFavoritar);
  });

  novoBtnSalvar.addEventListener("click", (e) => {
    e.stopPropagation();
    salvarFilme(novoBtnSalvar);
  });
}

// Chamar sempre que abrir o modal
document.querySelectorAll(".card").forEach(card => {
  card.addEventListener("click", async (e) => {
    if (e.target.closest(".btn-favoritar") || e.target.closest(".btn-salvar")) return;

    const imdbId = card.querySelector(".btn-favoritar")?.dataset.id;
    if (!imdbId) return;

    try {
      const resposta = await fetch(`/detalhes/${imdbId}`);
      const filme = await resposta.json();

      poster.src = filme.imagem || card.querySelector("img").src;
      titulo.textContent = filme.titulo || "TÃ­tulo nÃ£o disponÃ­vel";
      descricao.textContent = filme.descricao || "DescriÃ§Ã£o nÃ£o disponÃ­vel.";
      nota.textContent = filme.nota || "â€”";

      [btnFavoritarModal, btnSalvarModal].forEach(btn => {
        btn.dataset.id = imdbId;
        btn.dataset.titulo = filme.titulo;
        btn.dataset.imagem = filme.imagem;
        btn.dataset.genero = filme.genero;
      });

      atualizarEstadoBotaoFavorito(imdbId, favoritosIds.includes(imdbId));
      atualizarEstadoBotaoSalvar(imdbId, salvosIds.includes(imdbId));

      atualizarListenersModal(); // â† ðŸ’¥ Aqui Ã© a correÃ§Ã£o principal!

      modal.style.display = "flex";
      document.body.classList.add("modal-ativo");
    } catch (e) {
      console.error("Erro ao buscar detalhes:", e);
    }
  });
});

  // Fechar modal
  fechar.onclick = () => {
    modal.style.display = "none";
    document.body.classList.remove("modal-ativo");
  };
  modal.addEventListener("click", e => {
    if (e.target === modal) {
      modal.style.display = "none";
      document.body.classList.remove("modal-ativo");
    }
  });
});

</script>
</body>
</html>
