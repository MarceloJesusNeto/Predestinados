<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CineMatch - Perfil</title>
  <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/img/cinematchlogo1-removebg-preview (1).png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
<style>
    body {
  background-color: #0f0f0f;
  color: white;
  font-family: "Poppins", sans-serif;
  margin: 0;
}

header nav {
  padding: 10px 0px 0px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header ul {
  list-style: none;
  display: flex;
  gap: 25px;
}

header ul li a {
  color: #d46aff;
  text-decoration: none;
  font-weight: 600;
}

.perfil-container {
  width: 40%;
  margin: 135px auto;
  background: #141414;
  padding: 40px;
  border-radius: 10px;
  box-shadow: rgba(210, 106, 255, 0.25) 0px 4px 16px;
   font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;

}

.perfil-form {
  display: flex;
  flex-direction: column;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.perfil-form label {
  margin-top: 10px;
  font-weight: bold;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

/* ====== BOT√ïES GERAIS ====== */
button,
.btn-salvar,
.btn-remover,
.btn-favoritar {
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: "Nunito", sans-serif;
  font-weight: 600;
  transition: 0.3s;
}

/* ====== BOT√ÉO SALVAR ====== */
.btn-salvar {
  background-color: #c93aff; /* tom de roxo mais suave */
  color: white;
  padding: 8px 14px;
  font-size: 14px;
  margin-top: 8px;
}

.btn-salvar:hover {
  background-color: #d86aff;
  transform: scale(1.05);
}

/* ====== BOT√ÉO REMOVER ====== */
.btn-remover {
  background-color: transparent;
  border: 1px solid red;
  color: red;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 10px;
  width: 92px;
}

.btn-remover:hover {
  background-color: red;
  color: #fff;
  transform: scale(1.05);
}

/* ====== BOT√ÉO FAVORITAR ====== */
.btn-favoritar {
  background-color: #2a2a2a;
  color: #fff;
  border: 1px solid #d46aff;
  padding: 8px 14px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-right: 8px;
}

.btn-favoritar:hover {
  background-color: #d46aff;
  color: white;
  transform: scale(1.05);
}

/* ====== CARDS ====== */
.filme-card {
  background-color: #151515;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  box-shadow: 0 0 10px rgba(212, 106, 255, 0.2);
  transition: transform 0.3s, box-shadow 0.3s;
  justify-content: space-between;
  width: 350px;
  text-align: center;
  color: white;
  box-shadow: 0 0 15px 2px gold;
          padding: 10px;
          transition: transform .22s ease, box-shadow .22s ease;
          box-shadow: 0 6px 18px rgba(0,0,0,0.6);
          font-family: "Nunito", sans-serif;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
}

.filme-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 20px rgba(212, 106, 255, 0.4);
}

/* ====== BOT√ïES NO CARD ====== */
.filme-card button {
  margin-top: 8px;
}


.perfil-form input {
  padding: 10px;
  border: none;
  border-radius: 8px;
  margin-top: 4px;
  background-color: #1f1f1f;
  color: white;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.btn-salvar {
  margin-top: 20px;
  background-color: #d46aff;
  border: none;
  padding: 12px;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.btn-salvar:hover {
  background-color: #ff85ff;
}

.mensagem-sucesso {
  color: lightgreen;
  margin-top: 20px;
}

.mensagem-erro {
  color: #ff6b6b;
  margin-top: 20px;
}

.logout-form {
  text-align: center;
  margin-top: 30px;
}

.btn-logout {
  background: none;
  color: #bbb;
  border: none;
  cursor: pointer;
  font-size: 15px;
  transition: 0.3s;
}

.btn-logout:hover {
  color: #ff7070;
}

    .modal-foto {
  display: none;
  justify-content: center;
  align-items: center;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  z-index: 1000;
}

.modal-content-foto {
  background: #121212;
  padding: 25px;
  border-radius: 20px;
  width: 90%;
  max-width: 800px;
  color: #fff;
  text-align: center;
  max-height: 70vh; /* altura m√°xima reduzida */
  overflow-y: auto; /* scroll interno */
}

/* Barra de rolagem estilizada */
.modal-content-foto::-webkit-scrollbar {
  width: 8px;
}
.modal-content-foto::-webkit-scrollbar-thumb {
  background: #a020f0;
  border-radius: 10px;
}
.modal-content-foto::-webkit-scrollbar-thumb:hover {
  background: #d46aff;
}

.grade-fotos {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 15px;
  justify-items: center;
  margin: 20px auto;
}

.foto-opcao {
  width: 135px;
  height: 135px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: 0.2s;
  object-fit: cover;
}

.foto-opcao:hover {
  transform: scale(1.05);
}

.foto-opcao.selecionada {
  border: 3px solid #a020f0;
  box-shadow: 0 0 10px #a020f0;
}

    .foto-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  margin-bottom: 30px;
}

.foto-perfil {
  width: 180px; /* tamanho reduzido */
  height: 180px;
  border-radius: 50%;
  object-fit: cover;
  border: 4px solid #d46aff;
  box-shadow: 0 0 15px rgba(212, 106, 255, 0.4);
  margin-bottom: 10px;
}

    #salvarFoto,
#cancelarFoto {
  margin-top: 20px;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  border: none;
  transition: 0.3s;
}

#salvarFoto {
  background-color: #d46aff;
  color: white;
}

#salvarFoto:hover {
  background-color: #e277ff;
  transform: scale(1.05);
}

#cancelarFoto {
  background-color: transparent;
  border: 1px solid #bbb;
  color: #bbb;
  margin-left: 10px;
}

#cancelarFoto:hover {
  border-color: #ff7070;
  color: #ff7070;
  transform: scale(1.05);
}
    .modal-content-foto button {
  display: inline-block;
}


    .btn-salvar-perfil {
    margin-top: 20px;
    background-color: #d46aff;
    border: none;
    padding: 12px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: 0.3s;
    font-family: "Nunito", sans-serif;
    font-optical-sizing: auto;
    font-weight: <weight>;
    font-style: normal;
}

.btn-salvar-perfil:hover {
    background-color: #ff85ff;
    transform: scale(1.05);
}
</style>
<header th:if="${session.usuarioLogado != null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <nav class="nav-links">
        <a href="/">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="/pesquisa">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Pesquisar</span>
        </a>
        <a href="/chat">
            <i class="fa-solid fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="/curtidos">
            <i class="fa-solid fa-heart"></i>
            <span>Favoritos</span>
        </a>
        <a href="/perfil">
            <i class="fa-solid fa-user"></i>
            <span>Perfil</span>
        </a>
    </nav>
</header>

<header th:if="${session.usuarioLogado == null}">
    <h1>CineMatch</h1>
    <nav>
        <a href="/login" class="btn-login">Entrar</a>
        <a href="/registrar" class="btn-cadastrar">Cadastrar</a>
    </nav>
</header>

<main class="perfil-container">
    <h2>Meu Perfil üé¨</h2>

    <div class="foto-container">
        <img id="fotoPerfil"
             th:src="${usuario.fotoPerfil != null ? usuario.fotoPerfil.url : '/img/FOTO 1.png'}"
             alt="Foto de perfil"
             class="foto-perfil">
        <a href="#" id="trocarFotoBtn">Trocar foto</a>
    </div>

    <!-- Modal para escolha da foto -->
    <div id="modal-foto" class="modal-foto">
        <div class="modal-content-foto">
            <h2>Escolha sua foto de perfil:</h2>
            <div class="grade-fotos"></div>
            <button id="salvarFoto" class="btn-salvar-foto">Salvar</button>
            <button id="cancelarFoto" class="btn-cancelar">Cancelar</button>
        </div>
    </div>

    <form th:action="@{/perfil/atualizar}" method="post" class="perfil-form" id="perfilForm">
        <label>Nome</label>
        <input type="text" name="nome" th:value="${usuario.nome}" required>

        <label>Email</label>
        <input type="email" name="email" th:value="${usuario.email}" required>

        <!-- NOVO CAMPO: DESCRI√á√ÉO -->
        <label>Sobre mim (m√°x. 300 caracteres)</label>
        <textarea name="descricao" maxlength="300" placeholder="Conte um pouco sobre voc√™, seus filmes favoritos, g√™neros preferidos..."
                  th:text="${usuario.descricao}"
                  style="padding: 10px; border: none; border-radius: 8px; margin-top: 4px; background-color: #1f1f1f; color: white; font-family: 'Nunito', sans-serif; resize: vertical; min-height: 80px; width: 100%; box-sizing: border-box;"></textarea>
        <div class="char-count" style="text-align: right; font-size: 12px; color: #ccc; margin-top: 5px;">
            <span id="charCount">0</span>/300 caracteres
        </div>

        <label>Senha atual</label>
        <input type="password" name="senhaAtual" placeholder="Digite sua senha atual" required>

        <label>Nova senha</label>
        <input type="password" name="novaSenha" placeholder="Digite a nova senha (opcional)">

        <button type="submit" class="btn-salvar-perfil">Salvar altera√ß√µes</button>
    </form>

    <div th:if="${msg}" class="mensagem-sucesso">
        <i class="fa-solid fa-circle-check"></i> <span th:text="${msg}"></span>
    </div>

    <div th:if="${erro}" class="mensagem-erro">
        <i class="fa-solid fa-triangle-exclamation"></i> <span th:text="${erro}"></span>
    </div>

    <form action="/logout" method="get" class="logout-form">
        <button type="submit" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Sair da conta</button>
    </form>

</main>

<section th:if="${filmesSalvos != null and !filmesSalvos.isEmpty()}" class="melhores-filmes">
    <h2>üéûÔ∏è Seu Top 10:</h2>
    <div class="filmes-grid">
        <div th:each="f : ${filmesSalvos}" class="filme-card"
             th:attr="data-id=${f.imdbId}">
            <img th:src="${f.imagem}" th:alt="${f.titulo}">
            <h3 th:text="${f.titulo}"></h3>
            <p th:text="${f.genero}"></p>

            <button class="btn-remover"
                    th:attr="data-id=${f.imdbId}, data-titulo=${f.titulo}, data-imagem=${f.imagem}, data-genero=${f.genero}">
                <i class="fa-solid fa-bookmark"></i> Remover
            </button>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {

      /**
       * ============================
       * FUN√á√ÉO DE SALVAR FILME
       * ============================
       */
      async function salvarFilme(botao) {
        const imdbId = botao.getAttribute("data-id");
        const titulo = botao.getAttribute("data-titulo");
        const imagem = botao.getAttribute("data-imagem");
        const genero = botao.getAttribute("data-genero");

        try {
            const resposta = await fetch("/perfil/salvarFilme", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({ imdbId, titulo, imagem, genero })
            });

            const resultado = await resposta.text();

            if (resultado === "ADICIONADO") {
                botao.innerHTML = '<i class="fa-solid fa-bookmark-circle-check"></i> Salvo';
                botao.classList.add("salvo");
            } else if (resultado === "LIMITE") {
                alert("Voc√™ j√° salvou o limite m√°ximo de 10 filmes.");
            } else if (resultado === "ERRO_LOGIN") {
                alert("Voc√™ precisa estar logado para salvar filmes.");
            }
        } catch (erro) {
            console.error("Erro ao salvar filme:", erro);
        }
    }

      /**
       * ============================
       * FUN√á√ÉO DE REMOVER FILME
       * ============================
       */
async function removerFilme(botao) {
        const imdbId = botao.getAttribute("data-id");

        try {
            const resposta = await fetch(`/perfil/removerFilme/${imdbId}`, {
                method: "DELETE"
            });

            const texto = await resposta.text();

            if (resposta.ok && texto === "REMOVIDO") {
                const card = botao.closest(".filme-card");
                if (card) {
                    card.classList.add("fade-out");
                    setTimeout(() => card.remove(), 400);
                }
            } else if (texto === "ERRO_LOGIN") {
                alert("Voc√™ precisa estar logado para remover filmes.");
            } else {
                alert("Erro ao remover filme.");
                console.error("Resposta do servidor:", texto);
            }
        } catch (erro) {
            console.error("Erro ao remover filme:", erro);
        }
    }
      /**
       * ============================
       * EVENTOS DOS BOT√ïES
       * ============================
       */
       document.querySelectorAll(".btn-salvar[data-id]").forEach(botao => {
        botao.addEventListener("click", (e) => {
            e.preventDefault();
            salvarFilme(botao);
        });
    });

    // Bot√µes de remover
    document.querySelectorAll(".btn-remover").forEach(botao => {
        botao.addEventListener("click", (e) => {
            e.preventDefault();
            removerFilme(botao);
        });
    });

});

    // ============================
  // SALVAR PERFIL VIA AJAX
  // ============================
  const formPerfil = document.querySelector(".perfil-form");

if (formPerfil) {
    formPerfil.addEventListener("submit", async (e) => {
        e.preventDefault(); // evita reload da p√°gina

        const formData = new FormData(formPerfil);

        try {
            const resposta = await fetch("/perfil/atualizar", {
                method: "POST",
                body: formData
            });

            const texto = await resposta.text();

            // Limpa mensagens anteriores
            document.querySelector(".mensagem-sucesso")?.remove();
            document.querySelector(".mensagem-erro")?.remove();

            const msgContainer = document.createElement("div");
            msgContainer.classList.add("mensagem-retorno");

            if (resposta.ok && texto.includes("Perfil atualizado com sucesso")) {
                msgContainer.classList.add("mensagem-sucesso");
                msgContainer.innerHTML = `<i class="fa-solid fa-circle-check"></i> Perfil atualizado com sucesso!`;
            } else if (texto.includes("Senha atual incorreta")) {
                msgContainer.classList.add("mensagem-erro");
                msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Senha atual incorreta.`;
            } else if (texto.includes("Informe sua senha atual")) {
                msgContainer.classList.add("mensagem-erro");
                msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Informe sua senha atual.`;
            } else {
                msgContainer.classList.add("mensagem-erro");
                msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Ocorreu um erro ao atualizar o perfil.`;
            }

            formPerfil.insertAdjacentElement("afterend", msgContainer);

            // Remove mensagem ap√≥s 5 segundos
            setTimeout(() => msgContainer.remove(), 5000);

        } catch (erro) {
            console.error("Erro ao atualizar perfil:", erro);
            alert("Erro inesperado. Tente novamente.");
        }
    });
}

    let idFotoSelecionada = null;

async function abrirModalFoto() {
  const modal = document.getElementById("modal-foto");
  modal.style.display = "flex";

  const grade = document.querySelector(".grade-fotos");
  grade.innerHTML = "";

  const resp = await fetch("/perfil/fotos");
  const fotos = await resp.json();

  fotos.forEach(foto => {
    const img = document.createElement("img");
    img.src = foto.url;
    img.dataset.id = foto.id;
    img.classList.add("foto-opcao");
    img.onclick = () => {
      document.querySelectorAll(".foto-opcao").forEach(f => f.classList.remove("selecionada"));
      img.classList.add("selecionada");
      idFotoSelecionada = foto.id;
    };
    grade.appendChild(img);
  });
}

document.querySelector(".btn-salvar-foto").onclick = async () => {
  if (!idFotoSelecionada) return alert("Selecione uma foto");

  const resp = await fetch("/perfil/atualizarFoto", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `idFoto=${idFotoSelecionada}`
  });

  if (resp.ok) {
    location.reload();
  }
};

document.getElementById("cancelarFoto").onclick = () => {
  document.getElementById("modal-foto").style.display = "none";
};
    document.getElementById("trocarFotoBtn").addEventListener("click", abrirModalFoto);

    // ============================
// CONTADOR DE CARACTERES PARA DESCRI√á√ÉO
// ============================
document.addEventListener('DOMContentLoaded', function() {
    const descricaoTextarea = document.querySelector('textarea[name="descricao"]');
    const charCount = document.getElementById('charCount');

    if (descricaoTextarea && charCount) {
        // Atualizar contador inicial
        const initialLength = descricaoTextarea.value ? descricaoTextarea.value.length : 0;
        charCount.textContent = initialLength;
        updateCharCountStyle(initialLength);

        // Atualizar enquanto digita
        descricaoTextarea.addEventListener('input', function() {
            const length = this.value.length;
            charCount.textContent = length;
            updateCharCountStyle(length);
        });

        function updateCharCountStyle(length) {
            if (length > 300) {
                charCount.style.color = '#ff4444';
                charCount.style.fontWeight = 'bold';
            } else if (length > 250) {
                charCount.style.color = 'orange';
                charCount.style.fontWeight = 'normal';
            } else {
                charCount.style.color = '#ccc';
                charCount.style.fontWeight = 'normal';
            }
        }
    }
});

// ============================
// ATUALIZA√á√ÉO EM TEMPO REAL DA DESCRI√á√ÉO
// ============================
let descricaoTimeout;
const descricaoTextarea = document.querySelector('textarea[name="descricao"]');

if (descricaoTextarea) {
    descricaoTextarea.addEventListener('input', function() {
        clearTimeout(descricaoTimeout);

        // Salvar automaticamente ap√≥s 2 segundos sem digitar
        descricaoTimeout = setTimeout(async () => {
            const descricao = this.value;

            // Valida√ß√£o de comprimento
            if (descricao.length > 300) {
                showTempMessage('Descri√ß√£o muito longa (m√°x. 300 caracteres)', 'error');
                return;
            }

            try {
                const resposta = await fetch('/perfil/atualizarDescricao', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `descricao=${encodeURIComponent(descricao)}`
                });

                const resultado = await resposta.text();

                if (resultado === 'ATUALIZADO') {
                    showTempMessage('Descri√ß√£o salva automaticamente!', 'success');
                } else if (resultado === 'LIMITE_EXCEDIDO') {
                    showTempMessage('Descri√ß√£o muito longa (m√°x. 300 caracteres)', 'error');
                } else if (resultado === 'ERRO_LOGIN') {
                    showTempMessage('Erro de sess√£o. Fa√ßa login novamente.', 'error');
                }
            } catch (erro) {
                console.error('Erro ao salvar descri√ß√£o:', erro);
                showTempMessage('Erro ao salvar descri√ß√£o', 'error');
            }
        }, 2000);
    });
}

// ============================
// SUBMISS√ÉO DO FORMUL√ÅRIO PRINCIPAL
// ============================
const perfilForm = document.getElementById('perfilForm');

if (perfilForm) {
    perfilForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        try {
            const resposta = await fetch('/perfil/atualizar', {
                method: 'POST',
                body: formData
            });

            const texto = await resposta.text();

            // Limpa mensagens anteriores
            document.querySelector('.mensagem-sucesso')?.remove();
            document.querySelector('.mensagem-erro')?.remove();
            document.querySelector('.temp-message')?.remove();

            const msgContainer = document.createElement('div');
            msgContainer.classList.add('mensagem-retorno');

            if (texto.includes('Perfil atualizado com sucesso')) {
                msgContainer.classList.add('mensagem-sucesso');
                msgContainer.innerHTML = `<i class="fa-solid fa-circle-check"></i> ${texto}`;
            } else if (texto.includes('Senha atual incorreta') || texto.includes('Informe sua senha atual') || texto.includes('Descri√ß√£o muito longa')) {
                msgContainer.classList.add('mensagem-erro');
                msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${texto}`;
            } else {
                msgContainer.classList.add('mensagem-erro');
                msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Ocorreu um erro ao atualizar o perfil.`;
            }

            perfilForm.insertAdjacentElement('afterend', msgContainer);

            // Remove mensagem ap√≥s 5 segundos
            setTimeout(() => msgContainer.remove(), 5000);

        } catch (erro) {
            console.error('Erro ao atualizar perfil:', erro);
            showTempMessage('Erro inesperado. Tente novamente.', 'error');
        }
    });
}

// Fun√ß√£o para mostrar mensagem tempor√°ria
function showTempMessage(message, type) {
    // Remove mensagens tempor√°rias anteriores
    document.querySelectorAll('.temp-message').forEach(msg => msg.remove());

    const msgDiv = document.createElement('div');
    msgDiv.className = `temp-message ${type === 'success' ? 'mensagem-sucesso' : 'mensagem-erro'}`;
    msgDiv.style.marginTop = '10px';
    msgDiv.style.padding = '8px 12px';
    msgDiv.style.borderRadius = '6px';
    msgDiv.style.fontSize = '14px';
    msgDiv.style.animation = 'fadeInOut 3s ease-in-out';
    msgDiv.innerHTML = `<i class="fa-solid ${type === 'success' ? 'fa-circle-check' : 'fa-triangle-exclamation'}"></i> ${message}`;

    const charCount = document.querySelector('.char-count');
    if (charCount) {
        charCount.parentNode.appendChild(msgDiv);
    } else {
        document.querySelector('textarea[name="descricao"]').parentNode.appendChild(msgDiv);
    }

    // Remove ap√≥s 3 segundos
    setTimeout(() => msgDiv.remove(), 3000);
}
</script>
</body>
</html>
