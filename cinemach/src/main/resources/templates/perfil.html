<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CineMatch - Perfil</title>
  <link rel="stylesheet" href="/css/style.css">
    <link rel="shortcut icon" href="/img/cinematchlogo1-removebg-preview (1).png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/home.css">
</head>
<body>
<style>
    body {
  background-color: #0f0f0f;
  color: white;
  font-family: "Poppins", sans-serif;
  margin: 0;
}

header nav {
  padding: 10px 0px 0px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

header ul {
  list-style: none;
  display: flex;
  gap: 25px;
}

header ul li a {
  color: #d46aff;
  text-decoration: none;
  font-weight: 600;
}

.perfil-container {
  width: 40%;
  margin: 135px auto;
  background: #141414;
  padding: 40px;
  border-radius: 10px;
  box-shadow: rgba(210, 106, 255, 0.25) 0px 4px 16px;
   font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;

}

.perfil-form {
  display: flex;
  flex-direction: column;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.perfil-form label {
  margin-top: 10px;
  font-weight: bold;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

/* ====== BOT√ïES GERAIS ====== */
button,
.btn-salvar,
.btn-remover,
.btn-favoritar {
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: "Nunito", sans-serif;
  font-weight: 600;
  transition: 0.3s;
}

/* ====== BOT√ÉO SALVAR ====== */
.btn-salvar {
  background-color: #c93aff; /* tom de roxo mais suave */
  color: white;
  padding: 8px 14px;
  font-size: 14px;
  margin-top: 8px;
}

.btn-salvar:hover {
  background-color: #d86aff;
  transform: scale(1.05);
}

/* ====== BOT√ÉO REMOVER ====== */
.btn-remover {
  background-color: transparent;
  border: 1px solid red;
  color: red;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 13px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-top: 10px;
  width: 92px;
}

.btn-remover:hover {
  background-color: red;
  color: #fff;
  transform: scale(1.05);
}

/* ====== BOT√ÉO FAVORITAR ====== */
.btn-favoritar {
  background-color: #2a2a2a;
  color: #fff;
  border: 1px solid #d46aff;
  padding: 8px 14px;
  font-size: 14px;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  margin-right: 8px;
}

.btn-favoritar:hover {
  background-color: #d46aff;
  color: white;
  transform: scale(1.05);
}

/* ====== CARDS ====== */
.filme-card {
  background-color: #151515;
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  box-shadow: 0 0 10px rgba(212, 106, 255, 0.2);
  transition: transform 0.3s, box-shadow 0.3s;
  justify-content: space-between;
  width: 350px;
  text-align: center;
  color: white;
  box-shadow: 0 0 15px 2px gold;
          padding: 10px;
          transition: transform .22s ease, box-shadow .22s ease;
          box-shadow: 0 6px 18px rgba(0,0,0,0.6);
          font-family: "Nunito", sans-serif;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
}

.filme-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 0 20px rgba(212, 106, 255, 0.4);
}

/* ====== BOT√ïES NO CARD ====== */
.filme-card button {
  margin-top: 8px;
}


.perfil-form input {
  padding: 10px;
  border: none;
  border-radius: 8px;
  margin-top: 4px;
  background-color: #1f1f1f;
  color: white;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.btn-salvar {
  margin-top: 20px;
  background-color: #d46aff;
  border: none;
  padding: 12px;
  border-radius: 8px;
  color: white;
  cursor: pointer;
  font-weight: bold;
  transition: 0.3s;
  font-family: "Nunito", sans-serif;
  font-optical-sizing: auto;
  font-weight: <weight>;
  font-style: normal;
}

.btn-salvar:hover {
  background-color: #ff85ff;
}

.mensagem-sucesso {
  color: lightgreen;
  margin-top: 20px;
}

.mensagem-erro {
  color: #ff6b6b;
  margin-top: 20px;
}

.logout-form {
  text-align: center;
  margin-top: 30px;
}

.btn-logout {
  background: none;
  color: #bbb;
  border: none;
  cursor: pointer;
  font-size: 15px;
  transition: 0.3s;
}

.btn-logout:hover {
  color: #ff7070;
}
</style>
<header th:if="${session.usuarioLogado != null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <nav class="nav-links">
        <a href="/">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="/pesquisa">
            <i class="fa-solid fa-magnifying-glass"></i>
            <span>Pesquisar</span>
        </a>
        <a href="/chat">
            <i class="fa-solid fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="/curtidos">
            <i class="fa-solid fa-heart"></i>
            <span>Favoritos</span>
        </a>
        <a href="/perfil">
            <i class="fa-solid fa-user"></i>
            <span>Perfil</span>
        </a>
    </nav>
</header>

<header th:if="${session.usuarioLogado == null}">
    <h1>CineMatch</h1>
    <nav>
        <a href="/login" class="btn-login">Entrar</a>
        <a href="/registrar" class="btn-cadastrar">Cadastrar</a>
    </nav>
</header>

<main class="perfil-container">
    <h2>Meu Perfil üé¨</h2>

    <form th:action="@{/perfil/atualizar}" method="post" class="perfil-form">
        <label>Nome</label>
        <input type="text" name="nome" th:value="${usuario.nome}" required>

        <label>Email</label>
        <input type="email" name="email" th:value="${usuario.email}" required>

        <label>Senha atual</label>
        <input type="password" name="senhaAtual" placeholder="Digite sua senha atual" required>

        <label>Nova senha</label>
        <input type="password" name="novaSenha" placeholder="Digite a nova senha">

        <button type="submit" class="btn-salvar">Salvar altera√ß√µes</button>
    </form>

    <div th:if="${msg}" class="mensagem-sucesso">
        <i class="fa-solid fa-circle-check"></i> <span th:text="${msg}"></span>
    </div>

    <div th:if="${erro}" class="mensagem-erro">
        <i class="fa-solid fa-triangle-exclamation"></i> <span th:text="${erro}"></span>
    </div>

    <form action="/logout" method="get" class="logout-form">
        <button type="submit" class="btn-logout"><i class="fa-solid fa-right-from-bracket"></i> Sair da conta</button>
    </form>

</main>

<section th:if="${filmesSalvos != null and !filmesSalvos.isEmpty()}" class="melhores-filmes">
    <h2>üéûÔ∏è Seu Top 10:</h2>
    <div class="filmes-grid">
        <div th:each="f : ${filmesSalvos}" class="filme-card"
             th:attr="data-id=${f.imdbId}">
            <img th:src="${f.imagem}" th:alt="${f.titulo}">
            <h3 th:text="${f.titulo}"></h3>
            <p th:text="${f.genero}"></p>

            <button class="btn-remover"
                    th:attr="data-id=${f.imdbId}, data-titulo=${f.titulo}, data-imagem=${f.imagem}, data-genero=${f.genero}">
                <i class="fa-solid fa-bookmark"></i> Remover
            </button>
        </div>
    </div>
</section>

<script>
    document.addEventListener("DOMContentLoaded", () => {

      /**
       * ============================
       * FUN√á√ÉO DE SALVAR FILME
       * ============================
       */
      async function salvarFilme(botao) {
        const imdbId = botao.getAttribute("data-id");
        const titulo = botao.getAttribute("data-titulo");
        const imagem = botao.getAttribute("data-imagem");
        const genero = botao.getAttribute("data-genero");

        try {
          const resposta = await fetch("/perfil/salvarFilme", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({ imdbId, titulo, imagem, genero })
          });

          const resultado = await resposta.text();

          if (resultado === "ADICIONADO") {
            botao.innerHTML = '<i class="fa-solid fa-bookmark-circle-check"></i> Salvo';
          } else if (resultado === "LIMITE") {
            alert("Voc√™ j√° salvou o limite m√°ximo de 10 filmes.");
          } else if (resultado === "ERRO_LOGIN") {
            alert("Voc√™ precisa estar logado para salvar filmes.");
          }
        } catch (erro) {
          console.error("Erro ao salvar filme:", erro);
        }
      }

      /**
       * ============================
       * FUN√á√ÉO DE REMOVER FILME
       * ============================
       */
async function removerFilme(botao) {
  const imdbId = botao.getAttribute("data-id");

  try {
    const resposta = await fetch(`/perfil/removerFilme/${imdbId}`, {
      method: "DELETE"
    });

    const texto = await resposta.text();

    if (resposta.ok && texto === "REMOVIDO") {
      const card = botao.closest(".filme-card");
      if (card) {
        card.classList.add("fade-out");
        setTimeout(() => card.remove(), 400);
      }
    } else if (texto === "ERRO_LOGIN") {
      alert("Voc√™ precisa estar logado para remover filmes.");
    } else {
      alert("Erro ao remover filme.");
      console.error("Resposta do servidor:", texto);
    }
  } catch (erro) {
    console.error("Erro ao remover filme:", erro);
  }
}
      /**
       * ============================
       * EVENTOS DOS BOT√ïES
       * ============================
       */
      document.querySelectorAll(".btn-salvar").forEach(botao => {
        botao.addEventListener("click", () => salvarFilme(botao));
      });

      document.querySelectorAll(".btn-remover").forEach(botao => {
        botao.addEventListener("click", () => removerFilme(botao));
      });

    });

    // ============================
  // SALVAR PERFIL VIA AJAX
  // ============================
  const formPerfil = document.querySelector(".perfil-form");

  formPerfil.addEventListener("submit", async (e) => {
    e.preventDefault(); // evita reload da p√°gina

    const formData = new FormData(formPerfil);

    try {
      const resposta = await fetch("/perfil/atualizar", {
        method: "POST",
        body: formData
      });

      const texto = await resposta.text();

      // Limpa mensagens anteriores
      document.querySelector(".mensagem-sucesso")?.remove();
      document.querySelector(".mensagem-erro")?.remove();

      const msgContainer = document.createElement("div");
      msgContainer.classList.add("mensagem-retorno");

      if (resposta.ok && texto.includes("Perfil atualizado")) {
        msgContainer.classList.add("mensagem-sucesso");
        msgContainer.innerHTML = `<i class="fa-solid fa-circle-check"></i> Perfil atualizado com sucesso!`;
      } else if (texto.includes("Senha atual incorreta")) {
        msgContainer.classList.add("mensagem-erro");
        msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Senha atual incorreta.`;
      } else if (texto.includes("Informe sua senha atual")) {
        msgContainer.classList.add("mensagem-erro");
        msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Informe sua senha atual.`;
      } else {
        msgContainer.classList.add("mensagem-erro");
        msgContainer.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> Ocorreu um erro ao atualizar o perfil.`;
      }

      formPerfil.insertAdjacentElement("afterend", msgContainer);

      // Remove mensagem ap√≥s 5 segundos
      setTimeout(() => msgContainer.remove(), 5000);

    } catch (erro) {
      console.error("Erro ao atualizar perfil:", erro);
      alert("Erro inesperado. Tente novamente.");
    }
  });
</script>
</body>
</html>
