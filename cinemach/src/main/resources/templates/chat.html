<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8" />
    <title>CineMatch - Chat</title>

    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/home.css">
    <link rel="shortcut icon" href="/img/cinematchlogo1-removebg-preview (1).png" type="image/x-icon">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;400;600;900&display=swap" rel="stylesheet">

    <style>
        main {
            font-family: "Nunito", sans-serif;
            background-color: ##0b0014;
            height: 92vh;
            display: flex;
            justify-content: center;
            padding: 0;
            margin: 0;
            margin-bottom: px;
        }

        .chat-layout {
            display: grid;
            grid-template-columns: 320px 1fr 400px;
            gap: 25px;
            width: 100%;
            padding: 25px;
            height: 100%;
            box-sizing: border-box;
        }

        .sidebar {
            background-color: #0b0014;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            height: auto;
        }

        .tabs {
            display: flex;
            width: 100%;
            margin-bottom: 15px;
            gap: 10px;
        }

        .tabs button {
            flex: 1;
            padding: 10px;
            background-color: #140018;
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
        }

        .tabs button.active {
            background-color: #e60073;
        }

        .list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-card {
            display: flex;
            gap: 10px;
            background-color: #1E1E1E;
            padding: 10px;
            border-radius: 10px;
            align-items: center;
            transition:0.2s;
            width: 300px;
            height: 100px;
        }
       .chat-card strong {
            display: block;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 120px;
            font-weight: 700;
        }

        .chat-card:hover {
            background-color: #5700a0;
        }

        .chat-card img {
            width: 92px;
            height: 92px;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-card button {
            margin-top: 5px;
        }


        .chat-area {
            background-color: #111;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .messages {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px;
        }

        .msg {
            padding: 10px;
            margin: 5px 0;
            max-width: 70%;
            border-radius: 10px;
            color: #fff;
        }

        .msg.left {
            background-color: #24002b;
            align-self: flex-start;
        }

        .msg.right {
            background-color: #e60073;
            align-self: flex-end;
        }

        .chat-input {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 10px;
            margin-top: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            border: none;
            color: white;
            outline: none;
        }

        .chat-input button {
            background-color: #e60073;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .suggestions {
            background-color: #0b0014;
            border-radius: 12px;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .suggestions h3 {
            text-align: center;
            color: #e60073;
            margin-bottom: 15px;
        }

        .suggestions-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .suggestion-card {
            background-color: #1E1E1E;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .suggestion-card:hover {
            background-color: #5700a0;
        }

        .suggestion-card img {
            width: 85px;
            height: 85px;
            object-fit: cover;
            border-radius: 50%;
            margin-bottom: 10px;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: #ff0077;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #0b0014;
        }
       .suggestion-card strong {
    display: block;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 120px; /* ajuste se quiser mais ou menos espaço */
    font-weight: 700;
}

 .suggestion-card .alta {
  color: limegreen;
  font-weight: 700;
}

.suggestion-card .media {
  color: orange;
  font-weight: 700;
}

.suggestion-card .baixa {
  color: red;
  font-weight: 700;
}


    </style>
</head>
<body>

<header th:if="${session.usuarioLogado != null}">
    <div class="logo-header">
        <img src="/img/cinematchlogo1-removebg-preview.png" alt="CineMatch Logo">
        <h1>CineMatch</h1>
    </div>
    <nav class="nav-links">
        <a href="/"><i class="fa-solid fa-house"></i><span>Home</span></a>
        <a href="/pesquisa"><i class="fa-solid fa-magnifying-glass"></i><span>Pesquisar</span></a>
        <a href="/chat" class="active"><i class="fa-solid fa-comment"></i><span>Chat</span></a>
        <a href="/curtidos"><i class="fa-solid fa-heart"></i><span>Favoritos</span></a>
        <a href="/perfil"><i class="fa-solid fa-user"></i><span>Perfil</span></a>
    </nav>
</header>

<main class="chat-page">

    <div class="chat-layout">

        <!-- SIDEBAR -->
        <aside class="sidebar">

            <div class="tabs">
                <button id="chats-tab" class="active">CHATS</button>
                <button id="solicitacoes-tab">SOLICITAÇÕES</button>
            </div>

            <div id="chats-list" class="list">
                <div class="chat-card" th:each="chat : ${chats}">
                    <img th:src="${chat.destinatario.fotoPerfil != null ? chat.destinatario.fotoPerfil.url : '/img/user-default.png'}">
                    <div>
                        <p><strong th:text="${chat.destinatario.nome}"></strong></p>

                        <form th:action="@{/abrirChat}" method="get">
                            <input type="hidden" name="id" th:value="${chat.destinatario.id}">
                            <button class="abrir">Abrir</button>
                        </form>
                    </div>
                </div>
            </div>

            <div id="solicitacoes-list" class="list" style="display:none;">
                <div class="chat-card" th:each="sol : ${solicitacoes}">
                    <img th:src="${sol.remetente.fotoPerfil != null ? sol.remetente.fotoPerfil.url : '/img/user-default.png'}">
                    <div>
                        <p><strong th:text="${sol.remetente.nome}"></strong></p>

                        <form th:action="@{/responderSolicitacao}" method="post">
                            <input type="hidden" name="id" th:value="${sol.id}">
                            <button name="acao" value="aceitar" class="aceitar">Aceitar</button>
                            <button name="acao" value="negar" class="negar">Negar</button>
                        </form>
                    </div>
                </div>
            </div>

        </aside>

        <!-- CHAT CENTRAL -->
        <section class="chat-area">
            <div class="messages" id="messages">
                <div th:each="mensagem : ${mensagens}">
                    <div th:classappend="${mensagem.remetente.id == session.usuarioLogado.id} ? 'msg right' : 'msg left'"
                         th:text="${mensagem.conteudo}"></div>
                </div>
            </div>

            <form class="chat-input" th:action="@{/enviarMensagem}" method="post">
                <input type="hidden" name="destinatarioId" th:value="${destinatarioId}" />
                <input type="text" name="conteudo" placeholder="Digite..." required />
                <button type="submit">Enviar</button>
            </form>
        </section>

        <!-- SUGESTÕES -->
        <aside class="suggestions">
            <h3>Sugestões de pessoas pra conhecer</h3>

            <div class="suggestions-list">

                <div class="suggestion-card" th:each="s : ${sugeridos}">
                    <img th:src="${s.fotoPerfil != null ? s.fotoPerfil.url : '/img/user-default.png'}">

                    <p><strong th:text="${s.nome}"></strong></p>

                    <p>Compatibilidade:
                        <span th:text="${compatibilidades[s.id]}"
                              th:classappend="${compatibilidades[s.id] == 'Alta'} ? 'alta' :
                          (${compatibilidades[s.id] == 'Média'} ? 'media' : 'baixa')">
    </span>
                    </p>

                    <form th:action="@{/enviarSolicitacao}" method="post" onsubmit="enviarSolicitacao(event, this)">
                        <input type="hidden" name="id" th:value="${s.id}">
                        <button type="submit" class="enviar">Enviar</button>
                    </form>

                    <form th:action="@{/excluirSugestao}" method="post">
                        <input type="hidden" name="id" th:value="${s.id}">
                        <button type="submit" class="excluir">Excluir</button>
                    </form>

                </div>

            </div>
        </aside>

    </div>
</main>

<script>
    const chatsTab = document.getElementById("chats-tab");
const solicitacoesTab = document.getElementById("solicitacoes-tab");
const chatsList = document.getElementById("chats-list");
const solicitacoesList = document.getElementById("solicitacoes-list");

chatsTab.onclick = () => {
  chatsTab.classList.add("active");
  solicitacoesTab.classList.remove("active");
  chatsList.style.display = "flex";
  solicitacoesList.style.display = "none";
};

solicitacoesTab.onclick = () => {
  solicitacoesTab.classList.add("active");
  chatsTab.classList.remove("active");
  chatsList.style.display = "none";
  solicitacoesList.style.display = "flex";
};

function removerCard(form) {
  const card = form.closest('.suggestion-card');
  setTimeout(() => card.remove(), 300);
}

async function enviarSolicitacao(event, form) {
  event.preventDefault(); // impede reload

  const botao = form.querySelector('.enviar');
  botao.disabled = true;
  botao.textContent = 'Enviando...';

  try {
    const response = await fetch(form.action, {
      method: 'POST',
      body: new FormData(form)
    });

    const result = await response.text();

    if (result === 'ok') {
      form.closest('.suggestion-card').remove();
    } else if (result === 'jaExiste') {
      botao.textContent = 'Já enviada';
    } else {
      botao.textContent = 'Erro';
      botao.disabled = false;
    }

  } catch (e) {
    botao.textContent = 'Erro';
    botao.disabled = false;
    console.error(e);
  }
}

</script>

</body>
</html>
